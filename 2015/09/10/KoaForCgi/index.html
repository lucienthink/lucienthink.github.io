<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="最近有需求需要用到node来写一些简易的cgi，帮助后台同学减轻压力。
用node写cgi有两个问题，一个是端口，我们不能每加一个cgi就新增一个端口；第二个是异步回调问题，实现中会遇到很多例如读DB、读文件的异步行为，多层的callback会让代码很繁琐且不易输出内容。
于是想着用最近很火的tj大">
    

    <!--Author-->
    
        <meta name="author" content="Lucien">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="基于Koa和co使用node编写cgi"/>
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Ready to Fly"/>

    <!--Page Cover-->
    
        <meta property="og:image" content="undefined"/>
    

    <!-- Title -->
    
    <title>基于Koa和co使用node编写cgi - Ready to Fly</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/main.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


</head>

<body>

<!-- Menu -->
<!-- Navigation -->
<header>
    <div class="logo">
        <a href="/">Ready to Fly</a>
    </div><!-- end logo -->

    <div id="menu_icon"></div>
    <nav>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives">Archives</a>
            </li>
            
        </ul>
    </nav><!-- end navigation menu -->

    <div class="footer clearfix">
        <ul class="social clearfix">
            
            
            
            
            
            
        </ul><!-- end social -->

        <div class="rights">
            <!--<p>Copyright © 2014 magnetic.</p>-->
            <!--<p>Template by <a href="http://pixelhint.com/magnetic-free-html5-responsive-photography-website-template/">Pixelhint.com</a></p>-->
            <!--<p>Hexo Theme by <a href="http://www.codeblocq.com/">Jonathan K.</a></p>-->
            <p>http://lucienthink.github.io</p>
            <p>The Blog Of Lucien</p>
        </div><!-- end rights -->
    </div ><!-- end footer -->
</header><!-- end header -->

<!-- Main Content -->
<section class="main clearfix">

    <section class="top" style="background-image: url('/img/KoaForCgi-cover_detail.png');">
        <div class="wrapper content_header clearfix">
            

<div class="work_nav">

    <ul class="btn clearfix">
        
        <li><a href="/2016/05/30/RNlLearning-1/" class="previous" data-title="React Native笔记-1"></a></li>
        
        <li><a href="/" class="grid" data-title="Portfolio"></a></li>
        
        <li><a class="next disabled"></a></li>
        
    </ul>

</div><!-- end work_nav -->
            <h1 class="title">基于Koa和co使用node编写cgi</h1>
        </div>
    </section><!-- end top -->

    <section class="wrapper">
        <div class="content">

            <!-- Gallery -->
            

            <!-- Content -->
            <p>最近有需求需要用到node来写一些简易的cgi，帮助后台同学减轻压力。</p>
<p>用node写cgi有两个问题，一个是端口，我们不能每加一个cgi就新增一个端口；第二个是异步回调问题，实现中会遇到很多例如读DB、读文件的异步行为，多层的callback会让代码很繁琐且不易输出内容。</p>
<p>于是想着用最近很火的tj大神的Koa来搭建一套node-cgi框架。</p>
<p>先说说koa，koa是基于co的类似于express的web开发框架，了解koa首先要了解co，了解co首先要了解ES6的generator。</p>
<p>#1.generator</p>
<p>generator是ES6的新函数，写法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function* generator()&#123;</span><br><span class="line">   yield hello;</span><br><span class="line">   yield word;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var G = generator();</span><br><span class="line"></span><br><span class="line">console.log(G.next()); //&#123; value: hello, done: false &#125;</span><br><span class="line">console.log(G.next()); //&#123; value: word, done: false &#125;</span><br><span class="line">console.log(G.next()); //&#123; value: undefined, done: true &#125;</span><br></pre></td></tr></table></figure>
<p>generator使用yield的方法，让函数内部执行暂定，只有当调用next()方法的时候，才会接着往下走，同时返回一个对象，返回对象有两个值，一个是yield后面执行的结果，一个是done字段，如果yield都执行完了 done 字段就变为true。</p>
<p>使用yield来阻断函数内部执行，就可以将我们的异步函数转成同步执行。</p>
<p>#2. co</p>
<p>下来再看co，co帮助我们实现了自动调用next()方法，在co内部写yield，等待yield执行完毕就可以继续向下进行。</p>
<p>例如使用tof获取用户信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">co(function *() &#123;</span><br><span class="line">    var user = yield checkLogin(ticket, ip);</span><br><span class="line">    console.log(user);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">function checkLogin(ticket, ip)&#123;</span><br><span class="line">    return function (done) &#123;</span><br><span class="line">        tof.checkLogin(ticket, ip, function(err, result)&#123;</span><br><span class="line">            var user = result;</span><br><span class="line">            done(null, user);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#3. koa</p>
<p>koa和express一样，使用中间件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var koa = require(&apos;koa&apos;);</span><br><span class="line"></span><br><span class="line">var app = koa();</span><br><span class="line">app.use(function *() &#123;</span><br><span class="line">  this.body = &apos;Hello World!&apos;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8888);</span><br></pre></td></tr></table></figure>
<p> koa的Context 把 node 的 request, response 对象封装进一个单独对象, 并提供许多开发 web 应用和 APIs 有用的方法. 那些在 HTTP server 开发中使用非常频繁操作, 直接在 Koa 里实现, 而不是放在更高层次的框架, 这样中间件就不需要重复实现这些通用的功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(function *()&#123;</span><br><span class="line">  this; // is the Context</span><br><span class="line">  this.request; // is a koa Request</span><br><span class="line">  this.response; // is a koa Response</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p> 需要输出的内容，直接赋值给this.body即可。</p>
<ol>
<li>node-cgi</li>
</ol>
<p>了解完co和koa，我们就可以搭建一个简易的node-cgi框架，目录如下：</p>
<p>app.js作为入口，使用</p>
<p>node –harmony-generators app.js<br>来进行启动，在modules这块使用按需加载，拿到url里的参数后再加载对应的module：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var cgi = require(&apos;./modules/&apos; + cgiName);</span><br><span class="line"></span><br><span class="line">var result = yield function(done)&#123;</span><br><span class="line">    cgi(&apos;get&apos;, param, done);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样每次我们发布 只需替换modules文件夹里的js文件即可，不需要启停node服务（和php很像）。</p>
<p>而modules里的cgi文件，可以使用co来处理内部的异步回调，方法和koa相同，愉快同步向下写js从此开始了~</p>
<p>下面附上代码</p>
<p>app.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @fileOverview node-cgi入口</span><br><span class="line"> * @version 1.0.0</span><br><span class="line"> * @author &lt;a href=&quot;mailto:lucienxu@tencent.com&quot;&gt;lucienxu&lt;/a&gt;</span><br><span class="line"> * @date 2015/9/8</span><br><span class="line"> * @copyright Copyright (c) 2014, Tencent Inc. All rights reserved.</span><br><span class="line"> * @see [link]</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">var logger = require(&apos;koa-logger&apos;);</span><br><span class="line">var router = require(&apos;koa-router&apos;)();</span><br><span class="line">var parse = require(&apos;co-body&apos;);</span><br><span class="line">var tof = require(&apos;tof&apos;)(&apos;b90b498f8ab441afbcf4f023f7dd8e08&apos;);</span><br><span class="line">var koa = require(&apos;koa&apos;);</span><br><span class="line">var app = koa();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var posts = [];</span><br><span class="line"></span><br><span class="line">var user;</span><br><span class="line"></span><br><span class="line">app.keys = [&apos;some secret hurr&apos;];</span><br><span class="line"></span><br><span class="line">//app.env = &apos;production&apos;;</span><br><span class="line"></span><br><span class="line">//console.log(app.env);</span><br><span class="line"></span><br><span class="line">// middleware</span><br><span class="line"></span><br><span class="line">app.use(logger());</span><br><span class="line"></span><br><span class="line">router.get(&apos;/node-cgi/:cgiName&apos;, get);</span><br><span class="line">router.post(&apos;/node-cgi/:cgiName&apos;, post);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(router.routes()).use(router.allowedMethods());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(function *() &#123;</span><br><span class="line">    console.log(&apos;tof&apos;);</span><br><span class="line">    console.log(user)</span><br><span class="line">    if(user)&#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (&apos;production&apos; === app.env) &#123;</span><br><span class="line">        console.log(&apos;productation&apos;)</span><br><span class="line"></span><br><span class="line">        var ticket = this.cookies.get(&apos;TCOA_TICKET&apos;);</span><br><span class="line">        var ip = this.ip.substr(7);</span><br><span class="line">        var value;</span><br><span class="line">        yield checkLogin(ticket, ip);</span><br><span class="line"></span><br><span class="line">        console.log(user);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        console.log(&apos;dev&apos;);</span><br><span class="line">        user = &#123;</span><br><span class="line">            loginname: &quot;lucienxu&quot;,</span><br><span class="line">            chinesename: &quot;徐扬&quot;,</span><br><span class="line">            deptname: &quot;微信广告&quot;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">function checkLogin(ticket, ip)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return function (done) &#123;</span><br><span class="line">        tof.checkLogin(ticket, ip, function(err, result)&#123;</span><br><span class="line">            user = result;</span><br><span class="line">            //user = 1;</span><br><span class="line">            done();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// route definitions</span><br><span class="line"></span><br><span class="line">function *get(next)&#123;</span><br><span class="line">    yield next;</span><br><span class="line"></span><br><span class="line">    var cgiName = this.params.cgiName;</span><br><span class="line">    console.log(cgiName + &apos;: begin--get&apos;);</span><br><span class="line"></span><br><span class="line">    var param = this.request.query;</span><br><span class="line"></span><br><span class="line">    this.type = &apos;text/html; charset=utf-8&apos;;</span><br><span class="line">    this.set(&apos;Cache-Control&apos;, &apos;no-cache&apos;);</span><br><span class="line">    this.set(&apos;Connection&apos;, &apos;keep-alive&apos;);</span><br><span class="line"></span><br><span class="line">    var cgi = require(&apos;./modules/&apos; + cgiName);</span><br><span class="line"></span><br><span class="line">    var result = yield function(done)&#123;</span><br><span class="line">        cgi(&apos;get&apos;, param, done);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.body = param.callback + &apos;(&apos; + JSON.stringify(result) + &apos;)&apos;;</span><br><span class="line"></span><br><span class="line">    console.log(cgiName + &apos;: done--get&apos;);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function *post(next)&#123;</span><br><span class="line">    yield next;</span><br><span class="line"></span><br><span class="line">    var cgiName = this.params.cgiName;</span><br><span class="line">    console.log(cgiName + &apos;: begin--post&apos;);</span><br><span class="line">    var param = yield parse.form(this);</span><br><span class="line"></span><br><span class="line">    this.type = &apos;application/json; charset=utf-8&apos;;</span><br><span class="line">    this.set(&apos;Cache-Control&apos;, &apos;no-cache&apos;);</span><br><span class="line">    this.set(&apos;Connection&apos;, &apos;keep-alive&apos;);</span><br><span class="line">    this.set(&quot;Access-Control-Allow-Origin&quot;, this.header.origin);</span><br><span class="line">    this.set(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line"></span><br><span class="line">    var cgi = require(&apos;./modules/&apos; + cgiName);</span><br><span class="line"></span><br><span class="line">    var result = yield function(done)&#123;</span><br><span class="line">        cgi(&apos;post&apos;, param, done);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.body = result;</span><br><span class="line"></span><br><span class="line">    console.log(cgiName + &apos;: done--post&apos;);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// listen</span><br><span class="line"></span><br><span class="line">app.listen(33010);</span><br><span class="line">console.log(&apos;listening on port 33010&apos;);</span><br></pre></td></tr></table></figure>
<p>sns_super_white_list.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @fileOverview 超级白名单cgi</span><br><span class="line"> * @version 1.0.0</span><br><span class="line"> * @author &lt;a href=&quot;mailto:lucienxu@tencent.com&quot;&gt;lucienxu&lt;/a&gt;</span><br><span class="line"> * @date 2015/9/8</span><br><span class="line"> * @copyright Copyright (c) 2014, Tencent Inc. All rights reserved.</span><br><span class="line"> * @see [link]</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">var Sequelize = require(&apos;sequelize&apos;);</span><br><span class="line">var co = require(&apos;co&apos;);</span><br><span class="line">var db = new Sequelize(&apos;mysql://root@127.0.0.1:3306/xxx&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = function (method, param, resp) &#123;</span><br><span class="line">    /*</span><br><span class="line">    *   三个参数，method是get/post，param是传入参数，resp是输出数据</span><br><span class="line">    *   resp(err, result);</span><br><span class="line">    *   resp传入两个参数，第一个是错误信息，将通过console打印出来，第二项是输出的结果result，result为json格式</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    co(function *() &#123;</span><br><span class="line">        //db.sync();</span><br><span class="line"></span><br><span class="line">        db[&quot;t_misc_conf&quot;] = db.define(&apos;t_misc_conf&apos;, &#123;</span><br><span class="line">            key: &#123;</span><br><span class="line">                type: Sequelize.STRING,</span><br><span class="line">                primaryKey: true,</span><br><span class="line">            &#125;,</span><br><span class="line">            value: Sequelize.TEXT,</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            timestamps: false,</span><br><span class="line">            freezeTableName: true,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        console.log(method)</span><br><span class="line">        console.log(param)</span><br><span class="line"></span><br><span class="line">        var result;</span><br><span class="line"></span><br><span class="line">        if(method == &apos;get&apos;)&#123;</span><br><span class="line">            console.log(&apos;method - get&apos;)</span><br><span class="line">            switch (param.action)&#123;</span><br><span class="line">                case &apos;get_white_list&apos;:</span><br><span class="line">                    console.log(&apos;get_white_list&apos;)</span><br><span class="line">                    result = yield *getWhiteList();</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else if(method == &apos;post&apos;)&#123;</span><br><span class="line">            console.log(&apos;method - post&apos;)</span><br><span class="line">            switch (param.action)&#123;</span><br><span class="line">                case &apos;set_white_list&apos;:</span><br><span class="line">                    console.log(&apos;set_white_list&apos;)</span><br><span class="line">                    result = yield *setWhiteList(param);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resp(null, result);</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    function *getWhiteList()&#123;</span><br><span class="line">        console.log(&apos;get_white_list---begin&apos;)</span><br><span class="line">        var result = yield function (done) &#123;</span><br><span class="line">            db.t_misc_conf.findOne(&#123;where: &#123;key: &apos;super_whitelist&apos;&#125;&#125;).then(function (res) &#123;</span><br><span class="line">                console.log(&apos;get_white_list--yield--done&apos;)</span><br><span class="line">                console.log(res.get(&apos;value&apos;))</span><br><span class="line">                done(null, &#123;&quot;ret&quot;: 0, msg: &apos;success&apos;, &quot;result&quot;: res.get(&apos;value&apos;)&#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        console.log(&apos;get_white_list---done&apos;)</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function *setWhiteList(param)&#123;</span><br><span class="line">        console.log(&apos;set_white_list---begin&apos;)</span><br><span class="line">        var data = &#123;</span><br><span class="line">            value: param.value</span><br><span class="line">        &#125;</span><br><span class="line">        var result = yield function (done) &#123;</span><br><span class="line">            db.t_misc_conf.update(data, &#123;where: &#123;key: &apos;super_whitelist&apos;&#125;&#125;).then(function (res) &#123;</span><br><span class="line">                console.log(res)</span><br><span class="line">                done(null, &#123;&quot;ret&quot;: 0, msg: &apos;success&apos;&#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        console.log(&apos;set_white_list---done&apos;)</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>


            <!-- Tags -->
            


<div class="tags">
    <a href="/tags/koa/">koa</a>
</div>



            <!-- Comments -->
            <div>
                
    <hr />
    <h3>Kommentare:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



            </div>
        </div><!-- end content -->
    </section>
</section><!-- end main -->

<!-- After footer scripts -->

<!-- jQuery -->
<script src="/js/jquery.js"></script>

<!-- Custom Code -->
<script src="/js/main.js"></script>

<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'readytofly';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());

    setTimeout(function () {
        $('.main .work .media').each(function (i, item) {
            $(item).css({'transform': 'rotate(' + (parseInt(Math.random() * 10) - 5) + 'deg)'});
        })
    }, 200)
</script>


</body>

</html>